var ksutils={};(function(q){var store=undefined;var debug_mode=false;var queue_events=[];var queue_counter=0;var queue_autosend_timeout_id=null;var on_before_unload_callbacks=[];var qos={};var timers={};q.init=function(wb_callback){if($j('#player-debug').length){debug_mode=true;$j('#player-debug .start-queue').click(function(){$(this).hide();q.queue_autosend_enable();$j('.stop-queue').show();});$j('#player-debug .stop-queue').click(function(){q.queue_autosend_disable();$(this).hide();$j('.start-queue').show();});}
q.store=new window.Basil({namespace:q.namespace,storages:['local','cookie','session','memory'],expireDays:365*3});window.onbeforeunload=q._on_before_unload;q.register_on_before_unload_callback(function(){q.send_queue(true);});};q.get_current_unix_timestamp=function(){return Math.round(new Date().getTime()/1000);};q.is_debug_mode=function(){return debug_mode;};q.register_on_before_unload_callback=function(callback,position){if(position!=undefined&&position=='first'){on_before_unload_callbacks.unshift(callback);}else{on_before_unload_callbacks.push(callback);}};q._on_before_unload=function(){if(on_before_unload_callbacks.length){callback_returns=[];$j(on_before_unload_callbacks).each(function(index,callback){callback_return=callback();if(callback_return!==undefined){callback_returns.push(callback_return);}});if(callback_returns.length){return callback_returns.join(' | ');}}};q.get_player_error_codes=function(){var default_error_help="Try to refresh the page. If you still have trouble playing, please <a href='/contact/tech'>contact us</a> and we will fix it for you.";var default_error_title='Hmmm, seems like we have a problem...'
errors={"0":{"title":default_error_title,"code":"PLAYER_ERR_GENERIC","message":default_error_help},"PLAYER_UNAVAILABLE":{"title":default_error_title,"code":"PLAYER_UNAVAILABLE","message":default_error_help},"PLAYER_ERR_UNAUTHORIZED":{"title":default_error_title,"code":"PLAYER_ERR_UNAUTHORIZED","message":default_error_help},"PLAYER_ERR_INCOMPLETE_RESPONSE":{"title":default_error_title,"code":"PLAYER_ERR_INCOMPLETE_RESPONSE","message":default_error_help},"PLAYER_ERR_INVALID_KSA_REQUEST":{"title":default_error_title,"code":"PLAYER_ERR_INVALID_KSA_REQUEST","message":default_error_help},"1":{"title":"Video Download Aborted","code":"MEDIA_ERR_ABORTED","message":"The video download was cancelled. "+default_error_help},"2":{"title":default_error_title,"code":"MEDIA_ERR_NETWORK","message":"Seems like you've lost connection to the Internet. Please check your Internet connection and try again. "+default_error_help},"3":{"title":default_error_title,"code":"MEDIA_ERR_DECODE","message":"Seems like we are struggling to play on your browser. Please try a different browser. If you still have trouble playing, please <a href='/contact/tech'>contact us</a> and we will fix it for you."},"4":{"title":default_error_title,"code":"MEDIA_ERR_SRC_NOT_SUPPORTED","message":"Seems like we are struggling to play on your browser. Please try a different browser. If you still have trouble playing, please <a href='/contact/tech'>contact us</a> and we will fix it for you."},"5":{"title":default_error_title,"code":"MEDIA_ERR_ENCRYPTED","message":default_error_help},"-1":{"title":default_error_title,"code":"PLAYER_ERR_NO_SRC","message":default_error_help},"-2":{"title":default_error_title,"code":"PLAYER_ERR_TIMEOUT","message":"Seems like you've lost connection to the Internet. Please check your Internet connection and try again. "+default_error_help}};return errors;};q.set_player_placeholder_error=function(error){$player_placeholder=$j('.player-wrapper .placeholder').remove();icon=error.icon?error.icon:'frown';errors=q.get_player_error_codes();if(errors[error.code]){error=errors[error.code];}
html='<div class="placeholder with-shadow">'
+(error.image_src?'<img src="'+error.image_src+'" class="image" alt="'+error.image_alt+'">':'')
+'<span class="main status">'
+'<div class="icon"><i class="ui big '+icon+' icon"></i></div>'
+(error.title?'<div class="title">'+error.title+'</div>':'')
+(error.message?'<div class="text"><p>'+error.message+'</p></div>':'')
+(error.button?'<div class="button">'+error.button+'</div>':'')
+'</span>'
+'</div>';$j('.player-wrapper').prepend(html);data={};data.type='player_error';data.rid=ksa.getRequestID();data.error_code=error.code;ksutils.send_report('/ksa/plb',data,function(data){log('Error reported: OK');},function(data){log('Error reported: NOK')});Raven.captureMessage('VideoJS error "'+error.message+'". Error code: '+error.code,{level:'warning'});};q.report_qos=function(asset){if(asset.vpid!=undefined){data={};data.type='qos';data.vpid=asset.vpid;data.qos=qos;ksutils.queue(data);}};q.send_report=function(end_point,data,callback_success,callback_error){$j.ajax({type:"GET",url:end_point,data:data,dataType:"jsonp",beforeSend:function(xhr){log("Sending report...");},success:function(response,textStatus,jqXHR){if(response.status==1||response.status==true){log("Report success");callback_success(response);}else{log("Report error");callback_error(response);}},fail:function(response,textStatus,jqXHR){log("Request failed: "+textStatus);}});};q.queue=function(data,callback_success,callback_error){data.queue_id=queue_counter;data.client_timestamp=q.get_current_unix_timestamp();queue_counter++;queue_events.push(data);q.qos_item_set('nb_queue_items',queue_events.length);q.queue_autosend_enable();};q.send_queue=function(onbeforeunloadcall){if(queue_events.length>0){this_queue_events=queue_events;this_queue_events_string=JSON.stringify(this_queue_events);queue_events=[];if(onbeforeunloadcall&&navigator.sendBeacon){navigator.sendBeacon('/ksa/plb-v2',this_queue_events_string);}else{$j.ajax({type:'POST',url:'/ksa/plb-v2',data:{events:this_queue_events_string},dataType:"jsonp",async:!onbeforeunloadcall,beforeSend:function(xhr){log("About to send the queue to KS");q.qos_item_set('nb_queue_items',queue_events.length);},success:function(response,textStatus,jqXHR){if(response.status==1||response.status==true){q.qos_item_add('nb_ks_reports_success',1);if(response.ack&&response.ack.length<this_queue_events.length){log('WARNING: Not all events were acknowledged');}else{log('All events were acknowledged');}
q.qos_item_add('nb_queue_items_processed',this_queue_events.length);if(response.ks_total_play_ms){log('Time in DB: '+response.ks_total_play_ms);q.qos_item_set('time_in_db_ms',parseInt(response.ks_total_play_ms));}}else{if(response.error){ks_playlist.getPlayer().dispose();q.set_player_placeholder_error(response.error);}
log("Queue processing error");q.qos_item_add('nb_ks_reports_error',1);}
queue=q.get_queue();if(!queue.length){q.queue_autosend_disable();}},error:function(response,textStatus,jqXHR){console.log("Request error: "+textStatus);q.qos_item_add('nb_ks_reports_fail',1);q.re_queue_items(this_queue_events);},fail:function(response,textStatus,jqXHR){console.log("Request fail: "+textStatus);q.qos_item_add('nb_ks_reports_fail',1);q.re_queue_items(this_queue_events);}});}}else{log("Queue is empty, not sending");}};q.re_queue_items=function(queue){$j(queue).each(function(index,item){queue_events.push(item);q.qos_item_add('nb_queue_item_requeued',1);});q.queue_autosend_enable();};q.get_queue=function(){return queue_events;};q.queue_item_to_string=function(item){desc='';switch(item.type){case 'event':desc=item.category+'/'+item.action+'/'+item.label;break;case 'playback':desc=number_format(item.duration,2)+' sec';break;case 'qos':desc='Quality of Service';break;}
return '#'+item.queue_id+': '+item.type+' => '+desc;};q.queue_autosend_enable=function(){if(!queue_autosend_timeout_id){queue_autosend_timeout_id=setInterval(q.send_queue,30000);log('Queue autosend enabled');}};q.queue_autosend_disable=function(){if(queue_autosend_timeout_id){clearInterval(queue_autosend_timeout_id);queue_autosend_timeout_id=0;log('Queue autosend disabled');}};q.update_player_debug=function(){$j(['start_time_ms','video_buffer_ms','stalled_time_ms','time_queued_ms','buffering_time_ms','time_in_db_ms']).each(function(index,item){$j('#player-debug .'+item).text(qos[item]!=undefined?formatMstoSeconds(qos[item]):'?');});$j(['nb_dropped_frames','nb_queue_items','nb_queue_items_requeued','nb_queue_items_processed','nb_ks_reports_success','nb_ks_reports_error','nb_ks_reports_fail','nb_bufferings','nb_seeks']).each(function(index,item){$j('#player-debug .'+item).text(qos[item]!=undefined?qos[item]:'?');});$j(['rendition_id','rendition_size']).each(function(index,item){$j('#player-debug .'+item).text(qos[item]!=undefined?qos[item]:'?');});$j('#player-debug .rendition_bitrate_bps').text(qos['rendition_bitrate_bps']?(qos['rendition_bitrate_bps']/1000):'?');$j('#player-debug .queue-items li').remove();queue=q.get_queue();if(queue.length){$j(queue).each(function(index,item){$j('#player-debug .queue-items').append('<li>'+q.queue_item_to_string(item)+'</li>');});}else{$j('#player-debug .queue-items').append('<li><i>Empty queue...</i></li>');}};q.get_qos=function(){return qos;};q.qos_item_set=function(item,value){qos[item]=value;};q.qos_item_add=function(item,value){if(qos[item]!=undefined){qos[item]+=value;}else{qos[item]=value;}};q.start_timer=function(key){timers[key]=new Date().getTime();};q.stop_timer=function(key){elapsed=0;if(timers[key]!=undefined){time_start=timers[key];time_stop=new Date().getTime();elapsed=(time_stop-time_start)/1000;}
return elapsed;};if(typeof Raven!=='undefined'){Raven.context(q.init);}else{q.init();}
(function(){if(typeof sentry_host==='undefined'){return;}
var _window=typeof window!=='undefined'?window:typeof global!=='undefined'?global:typeof self!=='undefined'?self:{};function raven_log_http_request(status_code,response,method,url,detail,type){const raven_obj={level:status_code==undefined||status_code!=200?'error':'debug',category:"http-homemade",type:type,data:{status_code:status_code,response:status_code==undefined||status_code!=200?response:null,method:method,url:url,custom_detail:detail}};Raven.captureBreadcrumb(raven_obj);Raven.setTagsContext({http_code:status_code});}
function fill(obj,name,replacement){if(obj==null)return;var orig=obj[name];obj[name]=replacement(orig);obj[name].__raven__=true;obj[name].__orig__=orig;}
function isString(what){return Object.prototype.toString.call(what)==='[object String]';}
function is_sentry_url(url){return isString(url)&&url.indexOf(sentry_host)>-1;}
fill(_window,'fetch',function(origFetch){return function(){var args=new Array(arguments.length);for(var i=0;i<args.length;++i){args[i]=arguments[i];}
var fetchInput=args[0];var method='GET';var url;if(typeof fetchInput==='string'){url=fetchInput;}else if('Request'in _window&&fetchInput instanceof _window.Request){url=fetchInput.url;if(fetchInput.method){method=fetchInput.method;}}else{url=''+fetchInput;}
if(is_sentry_url(url)){return origFetch.apply(this,args);}
if(args[1]&&args[1].method){method=args[1].method;}
var fetchData={method:method,url:url,status_code:null};return origFetch.apply(this,args).then(function(response){fetchData.status_code=response.status;response.clone().text().then(function(res){raven_log_http_request(fetchData.status_code,res,fetchData.method,fetchData.url,'fetch_http','fetch')}).catch(function(err){raven_log_http_request(fetchData.status_code,err,fetchData.method,fetchData.url,'fetch_error_http','fetch')});return response;}).catch(function(err){raven_log_http_request(fetchData.status_code,err,fetchData.method,fetchData.url,'fetch_error_http','fetch');throw err;});};});var xhrproto=_window.XMLHttpRequest&&_window.XMLHttpRequest.prototype;fill(xhrproto,'open',function(origOpen){return function(method,url){if(!is_sentry_url(url)){this.addEventListener('load',function(){raven_log_http_request(this.status,this.response,method,url,'xhr_http','xhr');});this.addEventListener('error',function(){console.log(this);raven_log_http_request(this.status,this.response,method,url,'xhr_error_http','xhr');});this.addEventListener('abort',function(){console.log(this);raven_log_http_request(this.status,this.response,method,url,'xhr_abort_http','xhr');});}
return origOpen.apply(this,arguments);};});})();}(ksutils));