var ks_com_auth={modal:$j('#auth-modal'),popup:undefined,iframe:undefined,fakeOncloseEvent:undefined,external_auth_url:undefined,subdomain:undefined,destination:undefined,init:function(){this.bind_ui_actions();},bind_ui_actions:function(){$j('body').on('click','.auth-modal',ks_com_auth.click_auth_modal);},click_auth_modal:function(e){e.stopPropagation();ks_com_auth.subdomain=$(this).attr('data-subdomain');ks_com_auth.destination=$(this).attr('data-destination');ks_com_auth.open_auth_modal(ks_com_auth.subdomain);return false;},update_auth_modal_content:function(content,type){$j('.content',this.modal).html(content);},open_auth_modal:function(subdomain){this.update_auth_modal_content('<i class="big spinner loading icon"></i>');this.modal.modal("setting","autofocus",true).modal("setting","observeChanges",true).modal("setting","closable",false).modal("setting","offset",100).modal('show');$j('.close.icon',this.modal).click(function(){ks_com_auth.modal.modal('hide');});data={};if(subdomain){data['subdomain']=subdomain;}
$j.ajax({type:"GET",url:"/identity/verify/init",data:data,async:false,dataType:"json",beforeSend:function(data){}}).then(function(data){if(data.type=='iframe'){ks_com_auth.update_auth_modal_content('<iframe src="'+data.url+'" frameborder="0" scrolling="auto" id="auth-iframe" style="width: 100%;"></iframe>');$j("#auth-iframe").load(function(){var h=500;try{h=$j(this).contents().height();}catch(e){}
$j(this).height(h);$j(window).resize();console.log('resizing iframe to '+h);$("#auth-iframe").contents().find("#edit-login").focus();});}
if(data.type=='popup'){reopen_btn='<a href="#" onclick="ks_com_auth.open_auth_popup(\''+data.url+'\'); return false" class="ui big orange button" target="_blank">Continue</a>';if(!ks_com_auth.open_auth_popup(data.url)){ks_com_auth.update_auth_modal_content('To start watching, we first need to take you to your institution\'s authentication page<br><br>'+reopen_btn);}else{ks_com_auth.update_auth_modal_content('To start watching, we first need to take you to your institution\'s authentication page<br><br>'+reopen_btn);}}
ks_com_auth.register_message_listener();},function(xhr,status,error){ks_com_auth.update_auth_modal_content('Membership error, something went wrong with the request!');});},open_auth_popup:function(url){this.popup=open_popup(url,'Auth popup');ks_com_auth.external_auth_url=url;if(this.popup==null||typeof(this.popup)=='undefined'){return false;}else{this.popup.focus();this.fakeOncloseEvent=window.setInterval(function(){console.log('Popup check...');if(ks_com_auth.popup){if(!ks_com_auth.popup.parent){console.log('Popup has no location');window.clearInterval(ks_com_auth.fakeOncloseEvent);reopen_btn='';if(ks_com_auth.external_auth_url){reopen_btn='<a href="#" onclick="ks_com_auth.open_auth_popup(\''+ks_com_auth.external_auth_url+'\'); return false" class="ui big orange button" target="_blank">Try again</a>';}
ks_com_auth.update_auth_modal_content('Looks like your institution didn\'t recognize you.<br>Contact your institution or try again.<br><br>'+reopen_btn);}else{console.log('Popup has a location');}}},500);}
return true;},register_message_listener:function(){var eventMethod=window.addEventListener?"addEventListener":"attachEvent";var eventer=window[eventMethod];var messageEvent=eventMethod=="attachEvent"?"onmessage":"message";eventer(messageEvent,function(e){console.log("parent received message!: ",e.data);if(e.data.status!=undefined){switch(e.data.status){case 'success':ks_com_auth.update_auth_modal_content('Identified! Updating your membership now...');$j.ajax({type:"GET",url:"/identity/verify/apply",data:{ktoken:e.data.ktoken},dataType:"json",beforeSend:function(){console.log("Applying ktoken "+e.data.ktoken);}}).then(function(data){console.log(data);if(data.status){ks_com_auth.update_auth_modal_content(data.status_msg);if(ks_com_auth.destination){window.location=ks_com_auth.destination;}else{window.location.reload();}}else{ks_com_auth.update_auth_modal_content(data.status_msg);}
window.clearInterval(ks_com_auth.fakeOncloseEvent);},function(xhr,status,error){ks_com_auth.update_auth_modal_content('Authentication error, something went wrong with the request!');});if(ks_com_auth.popup!=undefined){ks_com_auth.popup.close();}
break;default:ks_com_auth.update_auth_modal_content('Something went wrong with the authentication...');break;}}else{console.log('Message received does not look like a Kanopy response. Bypassing!');}},false);console.log('PostMessage listener ready');}};$j(document).on("ready",function(){ks_com_auth.init();var destination_after_pin_entered='/';$j('body').on('click','.user-logout',function(e){e.preventDefault();destination_after_pin_entered='/logout';$.ajax({url:"/user/logout",type:"GET",dataType:"json",async:false,success:function(data){if(data.status){window.location=destination_after_pin_entered;}else{if(data.error==="PIN_REQUIRED"){$j('#pin-modal').modal('show');}}}});return false;});$j('body').on('click','.exit-kids-mode, .enter-kids-mode',function(e){e.preventDefault();if($j(this).hasClass('exit-kids-mode')){var action='exit-kids-mode';}else if($j(this).hasClass('enter-kids-mode')){var action='enter-kids-mode';}
if($j(this).attr('data-destination-after-pin-entered')){destination_after_pin_entered=$j(this).attr('data-destination-after-pin-entered');}else{destination_after_pin_entered='/';}
$.ajax({url:"/user/toggle-kanopy-kids",type:"POST",data:{action:action},dataType:"json",async:false,success:function(data){if(data.status){if(destination_after_pin_entered=='reload'){window.location.reload();}else{window.location=destination_after_pin_entered;}}else{if(data.error==="PIN_REQUIRED"){$j('#pin-modal').modal('show');}}}});return false;});$j('body').on('click','.change-pin-modal',function(e){e.preventDefault();$j('#change-pin-modal').modal('show');return false;});$j('body').on('submit','form.change-pin-ajax',function(e){e.preventDefault();var pin=$j("#change_parental_controls_pin-1").val();pin+=$j("#change_parental_controls_pin-2").val();pin+=$j("#change_parental_controls_pin-3").val();pin+=$j("#change_parental_controls_pin-4").val();var new_pin=$j("#change_new_parental_controls_pin-1").val();new_pin+=$j("#change_new_parental_controls_pin-2").val();new_pin+=$j("#change_new_parental_controls_pin-3").val();new_pin+=$j("#change_new_parental_controls_pin-4").val();if(pin.length===4&&new_pin.length===4){$.ajax({url:"/user/change-parental-controls-pin-ajax-submit",type:"POST",data:{pin:pin,new_pin:new_pin},dataType:"json",beforeSend:function(){$j("#change-pin-ajax-status").transition("hide");},success:function(data){if(data.status){$j('#change_parental_controls_pin_modal_content').html(data.msg);}else{$j(".parental_controls_pin.input").val('');$j("#change_parental_controls_pin-1").focus();$j("#change-pin-ajax-status").html(data.msg);$j("#change-pin-ajax-status").transition("fade in");}},error:function(){$j(".parental_controls_pin.input").val('');$j("#change_parental_controls_pin-1").focus();$j("#change-pin-ajax-status").html("Something went wrong");$j("#change-pin-ajax-status").transition("fade in");}});}
return false;});$j('body').on('click','.forgot-pin-modal',function(e){e.preventDefault();$j('#forgot-pin-modal').modal('show');return false;});$j('body').on('submit','form.forgot-pin-ajax',function(e){e.preventDefault();$.ajax({url:"/user/reset-parental-controls-pin-ajax-submit",type:"GET",dataType:"json",beforeSend:function(){$j("#forgot-pin-ajax-status").transition("hide");},success:function(data){if(data.status){$j('#forgot_parental_controls_pin_modal_content').html(data.msg);}else{$j("#forgot-pin-ajax-status").html(data.msg);$j("#forgot-pin-ajax-status").transition("fade in");}},error:function(){$j("#forgot-pin-ajax-status").html("Something went wrong");$j("#forgot-pin-ajax-status").transition("fade in");}});return false;});$target=$j('#pin-modal');$target.modal({autofocus:false,onVisible:function(){setTimeout(function(){$j("#parental_controls_pin-1").focus();});return false;},onHidden:function(){$j("#ajax-status").transition('hide');$j(".parental_controls_pin.input").val('');return false;}});$j('.close.icon',$target).click(function(){$target.modal('hide');});$j('body').on('submit','form.pin-ajax',function(){var pin=$j("#verify_parental_controls_pin-1").val();pin+=$j("#verify_parental_controls_pin-2").val();pin+=$j("#verify_parental_controls_pin-3").val();pin+=$j("#verify_parental_controls_pin-4").val();if(pin.length===4){$.ajax({url:"/user/verify-parental-controls-pin-ajax-submit",type:"POST",data:{pin:pin},dataType:"json",beforeSend:function(){$j("#ajax-status").transition("hide");},success:function(data){if(data.status){$j('#parental_controls_pin_modal_content').html(data.msg);setTimeout(function(){if(destination_after_pin_entered=='reload'){window.location.reload();}else{window.location=destination_after_pin_entered;}},1000);}else{$j(".parental_controls_pin.input").val('');$j("#verify_parental_controls_pin-1").focus();$j("#ajax-status").html(data.msg);$j("#ajax-status").transition("fade in");}},error:function(){$j(".parental_controls_pin.input").val('');$j("#verify_parental_controls_pin-1").focus();$j("#ajax-status").html("Something went wrong");$j("#ajax-status").transition("fade in");}});}
return false;});$j('.parental_controls_pin').keydown(function(e){if($j.inArray(e.keyCode,[8,9,13,27,46])!==-1||(e.keyCode===65&&(e.ctrlKey===true||e.metaKey===true))||(e.keyCode>=35&&e.keyCode<=40)){return;}
if((e.shiftKey||(e.keyCode<48||e.keyCode>57))&&(e.keyCode<96||e.keyCode>105)){e.preventDefault();}});$j('.parental_controls_pin').keyup(function(e){if((e.keyCode>=48&&e.keyCode<=57)||(e.keyCode>=96&&e.keyCode<=105)){var currentPinFieldNumber=Number(e.currentTarget.id.split('-')[1]);if($j(this).val().length==$j(this).attr('maxlength')&&currentPinFieldNumber<4){$j(this).parent().next().children()[0].focus();}}});$j('body').on('submit','form.classification-ajax',function(){$.ajax({url:"/user/verify-classification-ajax-submit",type:"POST",data:{confirm:$j("#classification-confirm").is(':checked'),classification:$j("#classification-rating").val()},dataType:"json",beforeSend:function(){$j("#classification_content .ajax-status").transition("hide");},success:function(data){if(data.status){$j('#classification_content').html(data.msg);ks_playlist._firstPlay();setTimeout(function(){$j('.player-wrapper-inner .placeholder').remove();},1000);}else{$j("#classification_content .ajax-status").html(data.msg);$j("#classification_content .ajax-status").transition("fade in");}},error:function(){$j("#classification_content .ajax-status").html("Something went wrong");$j("#classification_content .ajax-status").transition("fade in");}});return false;});});